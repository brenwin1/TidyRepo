---
title: "Coffee Ratings"
author: "Brendi"
date: "07/07/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library}
library(ggridges)
library(tidyverse)
library(gridExtra)
```

```{r cleaningscript, include=FALSE}
raw_arabica <-
  read_csv(
    "https://raw.githubusercontent.com/jldbc/coffee-quality-database/master/data/arabica_data_cleaned.csv"
  ) %>%
  janitor::clean_names()

raw_robusta <-
  read_csv(
    "https://raw.githubusercontent.com/jldbc/coffee-quality-database/master/data/robusta_data_cleaned.csv",
    col_types = cols(
      X1 = col_double(),
      Species = col_character(),
      Owner = col_character(),
      Country.of.Origin = col_character(),
      Farm.Name = col_character(),
      Lot.Number = col_character(),
      Mill = col_character(),
      ICO.Number = col_character(),
      Company = col_character(),
      Altitude = col_character(),
      Region = col_character(),
      Producer = col_character(),
      Number.of.Bags = col_double(),
      Bag.Weight = col_character(),
      In.Country.Partner = col_character(),
      Harvest.Year = col_character(),
      Grading.Date = col_character(),
      Owner.1 = col_character(),
      Variety = col_character(),
      Processing.Method = col_character(),
      Fragrance...Aroma = col_double(),
      Flavor = col_double(),
      Aftertaste = col_double(),
      Salt...Acid = col_double(),
      Balance = col_double(),
      Uniform.Cup = col_double(),
      Clean.Cup = col_double(),
      Bitter...Sweet = col_double(),
      Cupper.Points = col_double(),
      Total.Cup.Points = col_double(),
      Moisture = col_double(),
      Category.One.Defects = col_double(),
      Quakers = col_double(),
      Color = col_character(),
      Category.Two.Defects = col_double(),
      Expiration = col_character(),
      Certification.Body = col_character(),
      Certification.Address = col_character(),
      Certification.Contact = col_character(),
      unit_of_measurement = col_character(),
      altitude_low_meters = col_double(),
      altitude_high_meters = col_double(),
      altitude_mean_meters = col_double()
    )
  ) %>%
  janitor::clean_names() %>%
  rename(
    acidity = salt_acid,
    sweetness = bitter_sweet,
    aroma = fragrance_aroma,
    body = mouthfeel,
    uniformity = uniform_cup
  )


all_ratings <- bind_rows(raw_arabica, raw_robusta) %>%
  select(-x1) %>%
  select(total_cup_points, species, everything())

all_ratings %>%
  skimr::skim()

all_ratings %>%
  write_csv("coffee_ratings.csv")
```

Research Questions:

# 1. Does processing method influence coffee flavours? What are the general preferences?

[Characteristics of coffee in different processing methods](https://capecoffeebeans.co.za/blogs/cape-coffee-blog/77091524-7-factors-that-influence-coffee-flavour)  
1. Washed/Wet: Tend to have higher acidity and clarity  
2. Natural/Dry: Traditional african method, tend to have fruity flavour and low acidity; Higher risk of crop spoilage.  
3. Pulped natural/Honey: Collection of wet& dry methods  

```{r clean-proc}
proc_methods <- all_ratings %>%
  # Remove NA in processing methods
  filter(!is.na(processing_method),
  # Remove processing method 'other'
         !processing_method == "Other") %>%
  select(species, country_of_origin, processing_method:cupper_points, total_cup_points)
```


```{r proc-wider}
proc_wider <- proc_methods %>%
  # Group grade scores into one column
  pivot_longer(cols = aroma:cupper_points,
               names_to = "grade",
               values_to = "grade_score")
```

## Density Plot for Total Cup Points for each Processing Method

```{r proc-density, message = FALSE}
require(ggridges)

p1 <- proc_wider %>%
  ggplot(aes(x = total_cup_points,
             y = processing_method,
             fill = processing_method)) +
  stat_density_ridges(quantile_lines = TRUE,
                      quantiles = 0.5,
                      scale = 0.9,
                      alpha = 0.5
                      ) +
  scale_x_continuous(breaks = seq(50, 100, by = 5),
                     labels = c(seq(50, 100, by = 5))) +
  scale_fill_manual(values = c("#bcbc8f", "#8fbc8f", "#8f8fbc", "#bc8fbc")) +
  theme_classic() +
  theme(legend.position = "none")

p1
```

```{r}
proc_total_summ <- proc_wider %>%
                    group_by(processing_method) %>%
                    summarise(count = n(),
                              avg_total_cup_pts = mean(total_cup_points))
```

## Lollipop chart of each quality for each processing method

```{r proc-summary, message = FALSE}
# Mean grade score for each processing_method
proc_summary <- proc_methods %>%
  group_by(processing_method) %>%
  summarise(across(.cols = aroma:cupper_points, .fns = mean)) %>%
  ungroup() %>%
  pivot_longer(cols = aroma:cupper_points,
               names_to = "grade",
               values_to = "avg_score")
```

```{r proc-lollipop, fig.width = 7, fig.height = 7}
p2 <- proc_summary %>%
  ggplot(aes(x = avg_score, 
                 y = processing_method,
                 colour = processing_method
                 )) +
  geom_segment(aes(x = 0,
                   xend = avg_score,
                   y = processing_method,
                   yend = processing_method),
               colour = "grey") +
  xlab("Average Score") +
  ylab("Processing Method") +
  geom_point(
             size = 8
             ) +
  geom_text(color = "white", size = 2, label = round(proc_summary$avg_score, 2)) +
  scale_colour_manual(values = c("#bcbc8f", "#8fbc8f", "#8f8fbc", "#bc8fbc")) +
  facet_wrap(~ grade,
             nrow = 5,
             scales = "fixed") +
  theme_classic() +
  theme(legend.position = "none") 

p2
```

```{r}
library(ggpubr) 
theme_set(theme_pubr())

test <- ggpubr::ggtexttable(proc_total_summ, rows = NULL, 
                        theme = ttheme("mOrange"))

ggarrange(p1, test,
          nrow = 2)
```

2. Why does most restaurants Arabica beans over Robusta beans? What is the difference in terms of quality?

